<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Narrative Radar</title>
    <link rel="icon" href="/img/logo-sm.jpg" type="image/jpeg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --bg-primary: #0c0c14;
            --bg-surface: rgba(18,18,31,0.85);
            --bg-surface-hover: rgba(24,24,48,0.9);
            --bg-elevated: rgba(26,26,46,0.9);
            --border: #1e1e30;
            --border-hover: #2e2e48;
            --text-primary: #e8e8f0;
            --text-secondary: #8888a0;
            --text-muted: #5c5c74;
            --accent: #9945FF;
            --accent-hover: #b06aff;
            --accent-dim: rgba(153,69,255,0.12);
            --success: #00d18c;
            --success-dim: rgba(0,209,140,0.12);
            --warning: #f5a623;
            --warning-dim: rgba(245,166,35,0.12);
            --info: #67b8f9;
            --info-dim: rgba(103,184,249,0.12);
            --danger: #f87171;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 14px;
            --sidebar-width: 280px;
            --topnav-height: 56px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            background-image: url('/img/bg.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            line-height: 1.6; font-size: 15px;
            -webkit-font-smoothing: antialiased;
            overflow: hidden; height: 100vh;
        }

        /* === TOP NAV === */
        .top-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: rgba(12,12,20,0.95); backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            padding: 0 20px; height: var(--topnav-height);
            display: flex; align-items: center; justify-content: space-between;
        }
        .nav-left { display: flex; align-items: center; gap: 12px; }
        .hamburger {
            display: none; background: none; border: none; color: var(--text-primary);
            font-size: 1.4rem; cursor: pointer; padding: 4px 8px; border-radius: var(--radius-sm);
        }
        .hamburger:hover { background: var(--accent-dim); }
        .nav-brand {
            display: flex; align-items: center; gap: 10px;
            font-weight: 700; font-size: 1.05rem; color: var(--text-primary);
            text-decoration: none; cursor: pointer;
        }
        .nav-brand .logo { font-size: 1.3rem; }
        .nav-brand .logo-img { width: 32px; height: 32px; border-radius: 8px; vertical-align: middle; margin-right: 6px; }
        .nav-brand .brand-text span { color: var(--accent); }
        .nav-links { display: flex; align-items: center; gap: 6px; }
        .nav-link {
            color: var(--text-secondary); text-decoration: none; font-size: 0.8125rem;
            padding: 6px 12px; border-radius: var(--radius-sm); transition: all 0.15s;
            font-weight: 500;
        }
        .nav-link:hover { color: var(--text-primary); background: var(--accent-dim); }
        .nav-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--success-dim); color: var(--success);
            padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;
        }
        .nav-badge .pulse { width: 6px; height: 6px; border-radius: 50%; background: var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

        /* === LAYOUT === */
        .app-layout {
            display: flex; margin-top: var(--topnav-height); height: calc(100vh - var(--topnav-height));
        }

        /* === SIDEBAR === */
        .sidebar {
            width: var(--sidebar-width); min-width: var(--sidebar-width);
            background: var(--bg-surface); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; overflow: hidden;
            transition: transform 0.25s ease;
        }
        .sidebar-header {
            padding: 16px 16px 12px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .sidebar-header h2 { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-muted); }
        .sidebar-count { font-size: 0.7rem; color: var(--text-muted); background: var(--bg-primary); padding: 2px 8px; border-radius: 10px; }
        .sidebar-list { flex: 1; overflow-y: auto; padding: 8px; }
        .sidebar-list::-webkit-scrollbar { width: 4px; }
        .sidebar-list::-webkit-scrollbar-track { background: transparent; }
        .sidebar-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        .sidebar-item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: var(--radius-sm); cursor: pointer;
            transition: all 0.15s; margin-bottom: 2px; text-decoration: none;
            border: 1px solid transparent;
        }
        .sidebar-item:hover { background: var(--bg-surface-hover); border-color: var(--border); }
        .sidebar-item.active { background: var(--accent-dim); border-color: var(--accent); }
        .sidebar-item-info { flex: 1; min-width: 0; }
        .sidebar-item-name {
            font-size: 0.8125rem; font-weight: 600; color: var(--text-primary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .sidebar-item.active .sidebar-item-name { color: var(--accent); }
        .sidebar-item-meta { display: flex; align-items: center; gap: 6px; margin-top: 2px; }
        .sidebar-badge {
            font-size: 0.625rem; font-weight: 700; padding: 1px 6px; border-radius: 8px;
            text-transform: uppercase; letter-spacing: 0.3px;
        }
        .sidebar-badge.high { background: var(--success-dim); color: var(--success); }
        .sidebar-badge.medium { background: var(--warning-dim); color: var(--warning); }
        .sidebar-badge.low { background: var(--info-dim); color: var(--info); }
        .sidebar-trend { font-size: 0.75rem; }
        .sidebar-trend.accelerating { color: var(--success); }
        .sidebar-trend.emerging { color: var(--warning); }
        .sidebar-trend.stabilizing { color: var(--text-muted); }
        .sidebar-sources { display: flex; gap: 2px; font-size: 0.65rem; margin-top: 2px; }
        .sidebar-freshness { font-size: 0.6rem; color: var(--text-muted); margin-top: 1px; }

        .status-badge { font-size: 0.625rem; font-weight: 700; padding: 2px 7px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
        .status-badge.new { background: rgba(153,69,255,0.25); color: #c4b5fd; box-shadow: 0 0 8px rgba(153,69,255,0.3); animation: glowPulse 2s ease-in-out infinite; }
        @keyframes glowPulse { 0%,100% { box-shadow: 0 0 6px rgba(153,69,255,0.2); } 50% { box-shadow: 0 0 12px rgba(153,69,255,0.5); } }
        .status-badge.rising { background: var(--success-dim); color: var(--success); }
        .status-badge.stable { background: rgba(136,136,160,0.12); color: var(--text-secondary); }
        .status-badge.declining { background: rgba(248,113,113,0.12); color: var(--danger); }
        .status-badge.faded { background: rgba(92,92,116,0.12); color: var(--text-muted); opacity: 0.7; }

        .sidebar-home {
            display: flex; align-items: center; gap: 8px;
            padding: 10px 12px; margin: 0 8px 4px; border-radius: var(--radius-sm);
            cursor: pointer; transition: all 0.15s; font-size: 0.8125rem;
            font-weight: 600; color: var(--text-secondary); border: 1px solid transparent;
        }
        .sidebar-home:hover { background: var(--bg-surface-hover); color: var(--text-primary); }
        .sidebar-home.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }

        /* === MAIN CONTENT === */
        .main-content {
            flex: 1; overflow-y: auto; padding: 0;
        }
        .main-content::-webkit-scrollbar { width: 6px; }
        .main-content::-webkit-scrollbar-track { background: transparent; }
        .main-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

        /* === OVERVIEW (HOME) === */
        .overview { padding: 32px; max-width: 1100px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse-dot { 0%,100% { opacity:1; } 50% { opacity:0.3; } }
        .overview-hero { margin-bottom: 28px; }
        .overview-hero h1 { font-size: 1.75rem; font-weight: 700; margin-bottom: 4px; }
        .overview-hero p { color: var(--text-secondary); font-size: 0.9rem; }
        .overview-hero p a { color: var(--accent); text-decoration: none; }

        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px; margin-bottom: 28px;
        }
        .kpi-card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 16px 18px; transition: border-color 0.2s;
        }
        .kpi-card:hover { border-color: var(--border-hover); }
        .kpi-label { font-size: 0.6875rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text-muted); margin-bottom: 4px; }
        .kpi-value { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); line-height: 1.2; }
        .kpi-value.accent { color: var(--accent); }
        .kpi-value.success { color: var(--success); }
        .kpi-change { font-size: 0.75rem; font-weight: 500; margin-top: 2px; }
        .kpi-change.up { color: var(--success); }
        .kpi-change.down { color: var(--danger); }

        .overview-section-title { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 14px; text-transform: uppercase; letter-spacing: 0.5px; }

        .narrative-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 14px;
        }
        .narrative-grid-card {
            background: var(--bg-surface); border: 1px solid var(--border);
            border-radius: var(--radius-md); padding: 18px; cursor: pointer;
            transition: all 0.2s; border-left: 3px solid var(--border);
            animation: fadeInUp 0.4s ease-out both;
        }
        .narrative-grid-card:nth-child(1) { animation-delay: 0s; }
        .narrative-grid-card:nth-child(2) { animation-delay: 0.05s; }
        .narrative-grid-card:nth-child(3) { animation-delay: 0.1s; }
        .narrative-grid-card:nth-child(4) { animation-delay: 0.15s; }
        .narrative-grid-card:nth-child(5) { animation-delay: 0.2s; }
        .narrative-grid-card:nth-child(6) { animation-delay: 0.25s; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
        .narrative-grid-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 20px rgba(153,69,255,0.1); }
        .narrative-grid-card.confidence-high { border-left-color: var(--success); }
        .narrative-grid-card.confidence-medium { border-left-color: var(--warning); }
        .narrative-grid-card.confidence-low { border-left-color: var(--info); }
        .narrative-grid-card.faded-card { opacity: 0.55; border-left-color: var(--text-muted); }
        .narrative-grid-card.faded-card:hover { opacity: 0.8; border-color: var(--text-muted); box-shadow: none; }
        .narrative-grid-card.faded-card .grid-card-name { color: var(--text-secondary); }
        .faded-section-title { font-size: 0.875rem; font-weight: 600; color: var(--text-muted); margin: 28px 0 14px; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .faded-section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .faded-badge { display: inline-block; background: rgba(92,92,116,0.18); color: var(--text-muted); font-size: 0.65rem; font-weight: 700; padding: 2px 7px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.4px; }
        .grid-card-header { display: flex; justify-content: space-between; align-items: start; gap: 8px; margin-bottom: 8px; }
        .grid-card-name { font-size: 1rem; font-weight: 700; color: var(--text-primary); }
        .grid-card-badges { display: flex; gap: 4px; flex-shrink: 0; }
        .grid-card-desc { color: var(--text-secondary); font-size: 0.8125rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .grid-card-footer { display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 0.75rem; color: var(--text-muted); }
        .grid-card-signals { display: flex; gap: 4px; }

        /* === DETAIL VIEW === */
        .detail-view { padding: 32px; max-width: 900px; margin: 0 auto; animation: fadeIn 0.3s ease; }
        .detail-back {
            display: inline-flex; align-items: center; gap: 6px; color: var(--text-muted);
            font-size: 0.8125rem; cursor: pointer; margin-bottom: 20px; padding: 6px 12px;
            border-radius: var(--radius-sm); transition: all 0.15s; font-weight: 500;
        }
        .detail-back:hover { color: var(--accent); background: var(--accent-dim); }
        .detail-header { margin-bottom: 24px; }
        .detail-title { font-size: 1.75rem; font-weight: 700; color: var(--text-primary); margin-bottom: 8px; }
        .detail-badges { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; }
        .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; }
        .badge-high { background: var(--success-dim); color: var(--success); }
        .badge-medium { background: var(--warning-dim); color: var(--warning); }
        .badge-low { background: var(--info-dim); color: var(--info); }
        .badge-accelerating { background: rgba(153,69,255,0.12); color: #c4b5fd; }
        .badge-emerging { background: var(--info-dim); color: var(--info); }
        .badge-stabilizing { background: rgba(136,136,160,0.12); color: var(--text-secondary); }

        .detail-explanation { color: var(--text-secondary); font-size: 0.9375rem; line-height: 1.7; margin-bottom: 20px; }

        /* Velocity */
        .velocity-section { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .velocity-number { font-size: 1.2rem; font-weight: 700; }
        .velocity-number.accelerating { color: var(--success); }
        .velocity-number.emerging { color: var(--warning); }
        .velocity-number.stabilizing { color: var(--text-secondary); }
        .velocity-trend { font-size: 0.875rem; color: var(--text-muted); }
        .sparkline-container { display: inline-flex; align-items: end; gap: 2px; height: 24px; }
        .sparkline-bar { width: 7px; border-radius: 2px 2px 0 0; min-height: 2px; transition: height 0.3s; }
        .sparkline-bar.accelerating { background: var(--success); }
        .sparkline-bar.emerging { background: var(--warning); }
        .sparkline-bar.stabilizing { background: var(--text-muted); }

        /* Market opportunity */
        .market-opportunity {
            background: var(--success-dim); border: 1px solid rgba(0,209,140,0.2);
            border-left: 3px solid var(--success);
            border-radius: var(--radius-sm); padding: 14px 16px; margin-bottom: 20px;
        }
        .market-opportunity .label { color: var(--success); font-weight: 600; font-size: 0.8125rem; margin-bottom: 4px; }
        .market-opportunity .content { color: var(--text-secondary); font-size: 0.875rem; line-height: 1.6; }

        /* Charts */
        .charts-row {
            display: grid; grid-template-columns: 1fr 160px; gap: 16px;
            align-items: start; margin-bottom: 20px;
        }
        .trend-chart-wrap { min-width: 0; background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; }
        .trend-chart-wrap canvas { width: 100% !important; height: 200px !important; }
        .donut-chart-wrap { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 16px; text-align: center; }
        .donut-chart-wrap canvas { width: 128px !important; height: 128px !important; margin: 0 auto; }
        .chart-label { color: var(--text-muted); font-size: 0.6875rem; text-align: center; margin-top: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Signals */
        .detail-section { margin-bottom: 24px; }
        .detail-section-title { font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
        .signal-item {
            color: var(--text-secondary); font-size: 0.875rem; padding: 8px 0 8px 12px;
            border-left: 2px solid var(--border); margin: 6px 0; transition: border-color 0.15s;
        }
        .signal-item:hover { border-left-color: var(--accent); }
        .signal-item .signal-main { display: flex; align-items: baseline; gap: 6px; }
        .signal-item a { color: var(--accent); text-decoration: none; transition: color 0.15s; }
        .signal-item a:hover { color: var(--accent-hover); text-decoration: underline; }
        .signal-comment { color: var(--text-muted); font-size: 0.8125rem; font-style: italic; margin-top: 2px; padding-left: 2px; }
        .source-badge { font-size: 0.75rem; opacity: 0.8; flex-shrink: 0; }
        .show-all-toggle { color: var(--accent); cursor: pointer; font-size: 0.8125rem; margin-top: 6px; padding-left: 14px; font-weight: 500; }
        .show-all-toggle:hover { text-decoration: underline; }
        .signal-breakdown { color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 8px; }
        .signal-meta-row {
            display: flex; align-items: center; gap: 8px; flex-wrap: wrap;
            margin-top: 4px; padding-left: 2px; font-size: 0.75rem; color: var(--text-muted);
        }
        .signal-meta-row .meta-badge {
            display: inline-flex; align-items: center; gap: 3px;
            background: var(--bg-primary); border: 1px solid var(--border);
            border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; white-space: nowrap;
        }
        .signal-meta-row .meta-badge.active { border-color: var(--success); color: var(--success); }
        .signal-meta-row .meta-badge.kol { border-color: #1d9bf0; color: #1d9bf0; }

        /* TVL */
        .tvl-mini-chart-wrap { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin-left: 8px; }
        .tvl-summary { font-size: 0.75rem; color: var(--text-muted); margin-top: 2px; white-space: nowrap; }
        .tvl-summary.up { color: var(--success); }
        .tvl-summary.down { color: var(--danger); }
        .narrative-tvl-summary {
            display: inline-flex; align-items: center; gap: 6px;
            background: var(--accent-dim); border-radius: 20px;
            padding: 4px 12px; font-size: 0.75rem; font-weight: 600; color: var(--accent);
        }
        .narrative-tvl-summary.up { background: var(--success-dim); color: var(--success); }
        .narrative-tvl-summary.down { background: rgba(248,113,113,0.12); color: var(--danger); }

        /* Key metrics */
        .key-metrics-row { display: flex; gap: 10px; flex-wrap: wrap; margin: 12px 0; }
        .key-metric-card {
            background: var(--bg-primary); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 10px 14px; flex: 1; min-width: 130px;
        }
        .key-metric-label { color: var(--text-muted); font-size: 0.6875rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
        .key-metric-value { color: var(--text-primary); font-size: 1.3rem; font-weight: 700; margin: 2px 0; }
        .key-metric-context { color: var(--text-muted); font-size: 0.75rem; }

        /* Ideas */
        .ideas-section {
            padding: 20px; border-radius: var(--radius-md);
            background: var(--bg-surface); border: 1px solid var(--border); margin-bottom: 20px;
        }
        .ideas-title { color: var(--accent); font-size: 1rem; font-weight: 700; margin-bottom: 4px; }
        .ideas-subtitle { color: var(--text-muted); font-size: 0.8125rem; margin-bottom: 12px; }
        .idea-card {
            background: var(--bg-primary); border: 1px solid var(--border);
            border-radius: var(--radius-sm); padding: 14px 18px; margin: 8px 0; transition: border-color 0.15s;
        }
        .idea-card:hover { border-color: var(--border-hover); }
        .idea-name { color: var(--success); font-weight: 700; font-size: 0.9375rem; }
        .idea-desc { color: var(--text-secondary); font-size: 0.875rem; margin-top: 5px; line-height: 1.6; }
        .idea-market-analysis { color: var(--text-secondary); font-size: 0.8125rem; margin-top: 8px; padding: 8px 12px; background: var(--bg-surface); border-radius: var(--radius-sm); border-left: 2px solid var(--info); }
        .idea-revenue { color: var(--warning); font-size: 0.8125rem; margin-top: 5px; }
        .idea-refs { color: var(--text-muted); font-size: 0.8125rem; margin-top: 5px; }
        .idea-refs a { color: var(--accent); text-decoration: none; }
        .idea-refs a:hover { text-decoration: underline; }
        .idea-meta { color: var(--text-muted); font-size: 0.8125rem; margin-top: 5px; }
        .idea-why-now {
            border-left: 3px solid var(--success); background: var(--success-dim);
            padding: 8px 12px; border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
            margin-top: 8px; font-size: 0.8125rem; color: var(--text-secondary); line-height: 1.6;
        }
        .idea-why-now .prefix { color: var(--success); font-weight: 600; }

        /* References */
        .references { margin: 12px 0; }
        .references .label { color: var(--text-muted); font-size: 0.75rem; margin-bottom: 4px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        .references a { color: var(--accent); text-decoration: none; font-size: 0.8125rem; margin-right: 12px; display: inline-block; margin-bottom: 4px; }
        .references a:hover { color: var(--accent-hover); text-decoration: underline; }

        /* Nav arrows */
        .detail-nav {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px 0; margin-top: 16px; border-top: 1px solid var(--border);
        }
        .detail-nav-btn {
            display: inline-flex; align-items: center; gap: 8px;
            padding: 10px 18px; border-radius: var(--radius-sm); cursor: pointer;
            background: var(--bg-surface); border: 1px solid var(--border);
            color: var(--text-secondary); font-size: 0.8125rem; font-weight: 500;
            transition: all 0.15s; font-family: inherit;
        }
        .detail-nav-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .detail-nav-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .detail-nav-btn:disabled:hover { border-color: var(--border); color: var(--text-muted); background: var(--bg-surface); }
        .detail-nav-name { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Loading */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(12,12,20,0.88);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; gap: 16px; backdrop-filter: blur(4px);
        }
        .loading-overlay .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        .loading-overlay p { color: var(--text-secondary); font-size: 0.9375rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
            background: #2d1015; color: var(--danger); padding: 12px 20px; border-radius: var(--radius-md);
            font-size: 0.875rem; z-index: 1001; display: flex; align-items: center; gap: 12px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.5); max-width: 90%; border: 1px solid rgba(248,113,113,0.2);
        }
        .error-toast button {
            background: var(--danger); color: white; border: none; padding: 5px 14px;
            border-radius: var(--radius-sm); cursor: pointer; font-size: 0.8125rem; font-family: inherit; font-weight: 500;
        }

        /* Skeleton */
        .skeleton { background: linear-gradient(90deg, var(--bg-surface) 25%, var(--bg-elevated) 50%, var(--bg-surface) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: var(--radius-sm); }
        .kpi-skeleton { display: inline-block; width: 48px; height: 28px; vertical-align: middle; }
        .kpi-value .kpi-skeleton { border-radius: 6px; }
        #loading-overlay-init { position: fixed; inset: 0; z-index: 9999; background: var(--bg-base); display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 16px; transition: opacity 0.4s ease; }
        #loading-overlay-init.fade-out { opacity: 0; pointer-events: none; }
        #loading-overlay-init .spinner-ring { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes countUp { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
        .kpi-value.animated { animation: countUp 0.35s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { background: var(--bg-surface); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 22px; margin-bottom: 16px; }
        .skeleton-line { height: 14px; margin-bottom: 10px; border-radius: 4px; }
        .skeleton-line.w60 { width: 60%; } .skeleton-line.w80 { width: 80%; } .skeleton-line.w40 { width: 40%; } .skeleton-line.h24 { height: 24px; }
        .skeleton-chart { height: 160px; border-radius: var(--radius-sm); margin-top: 12px; }

        /* Mobile overlay */
        .sidebar-overlay {
            display: none; position: fixed; inset: 0; z-index: 149;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
        }
        .sidebar-overlay.visible { display: block; }

        /* === MOBILE === */
        @media (max-width: 768px) {
            .hamburger { display: block; }
            .sidebar {
                position: fixed; left: 0; top: var(--topnav-height); bottom: 0;
                z-index: 150; transform: translateX(-100%);
                width: 85vw; max-width: 320px;
            }
            .sidebar.open { transform: translateX(0); }
            .nav-links .nav-link { display: none; }
            #mobile-countdown { display: flex !important; }
            .overview { padding: 20px 16px; }
            .detail-view { padding: 20px 16px; }
            .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .kpi-value { font-size: 1.4rem; }
            .narrative-grid { grid-template-columns: 1fr; }
            .charts-row { grid-template-columns: 1fr; }
            .donut-chart-wrap { width: 160px; margin: 0 auto; }
            .sidebar-item { padding: 12px 14px; }
            .detail-back { padding: 10px 14px; font-size: 0.875rem; }
            .detail-title { font-size: 1.4rem; }
            .key-metrics-row { gap: 8px; }
            .key-metric-card { min-width: 110px; padding: 8px 10px; }
        }
        @media (max-width: 480px) {
            .nav-badge { display: none; }
        }

        /* Footer inside main */
        .main-footer {
            text-align: center; padding: 28px 24px; color: var(--text-muted);
            font-size: 0.8125rem; border-top: 1px solid var(--border); margin-top: 32px;
        }
        .main-footer a { color: var(--accent); text-decoration: none; }
        .main-footer a:hover { text-decoration: underline; }
        .footer-links { margin-top: 10px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }

        .btn {
            background: var(--accent); color: white; border: none; padding: 8px 20px;
            border-radius: var(--radius-sm); cursor: pointer; font-size: 0.8125rem;
            font-family: inherit; font-weight: 600; transition: all 0.15s;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn:disabled { background: var(--bg-elevated); color: var(--text-muted); cursor: not-allowed; }
        .btn-sm { padding: 5px 12px; font-size: 0.75rem; }

        /* Investment signals */
        .risk-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .risk-low { background: var(--success-dim); color: var(--success); }
        .risk-medium { background: var(--warning-dim); color: var(--warning); }
        .risk-high { background: rgba(248,113,113,0.12); color: var(--danger); }
        .key-projects { display: flex; flex-wrap: wrap; gap: 8px; margin: 12px 0; }
        .key-project-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; border-radius: 16px; font-size: 0.8rem; font-weight: 500; background: var(--accent-dim); color: var(--accent); border: 1px solid rgba(153,69,255,0.2); text-decoration: none; transition: all 0.15s; }
        .key-project-tag:hover { background: rgba(153,69,255,0.2); border-color: var(--accent); }
        .action-buttons { display: flex; gap: 8px; flex-wrap: wrap; margin: 16px 0; }
        .action-btn { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: var(--radius-sm); font-size: 0.8125rem; font-weight: 500; text-decoration: none; transition: all 0.15s; border: 1px solid var(--border); color: var(--text-secondary); background: var(--bg-surface); }
        .action-btn:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-dim); }
        .why-build-section { background: linear-gradient(135deg, rgba(153,69,255,0.08), rgba(0,209,140,0.08)); border: 1px solid rgba(153,69,255,0.15); border-left: 3px solid var(--accent); border-radius: var(--radius-sm); padding: 16px 18px; margin-bottom: 20px; }
        .why-build-section .label { color: var(--accent); font-weight: 700; font-size: 0.875rem; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
        .why-build-section .content { color: var(--text-secondary); font-size: 0.875rem; line-height: 1.7; }
    </style>
    <script src="https://browser.sentry-cdn.com/8.0.0/bundle.min.js" crossorigin="anonymous"></script>
    <script>
        if (typeof Sentry !== 'undefined') {
            Sentry.init({ dsn: "https://3536aa355800a646a43c003d5e43baf8@o4510503621296128.ingest.de.sentry.io/4510877888938064" });
        }
    </script>
</head>
<body>
    <div id="loading-overlay-init"><div class="spinner-ring"></div><div style="color:var(--text-muted);font-size:0.85rem">Loading narratives‚Ä¶</div></div>
    <!-- Persona picker removed ‚Äî go straight to content -->

    <nav class="top-nav">
        <div class="nav-left">
            <button class="hamburger" onclick="toggleSidebar()" aria-label="Toggle menu">‚ò∞</button>
            <a class="nav-brand" onclick="navigate('')">
                <img src="/img/logo-sm.jpg" alt="Radar" class="logo-img">
                <span class="brand-text">Solana <span>Radar</span></span>
            </a>
        </div>
        <div class="nav-links">
            <a href="https://github.com/0xksure/solana-narrative-radar#readme" target="_blank" class="nav-link">Methodology</a>
            <a href="https://github.com/0xksure/solana-narrative-radar" target="_blank" class="nav-link">GitHub</a>
            <span class="nav-badge"><span class="pulse"></span> Live</span>
        </div>
    </nav>

    <div class="app-layout">
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Narratives</h2>
                <span class="sidebar-count" id="sidebar-count">0</span>
            </div>
            <div class="sidebar-home active" onclick="navigate('')" id="sidebar-home">üìä Overview</div>
            <div class="sidebar-home" onclick="navigate('agents')" id="sidebar-agents">ü§ñ For Agents</div>
            <div class="sidebar-list" id="sidebar-list"></div>
        </aside>
        <main class="main-content" id="main-content">
            <div class="overview" id="overview-view">
                <div class="overview-hero">
                    <h1><img src="/img/logo-sm.jpg" alt="" style="width:36px;height:36px;border-radius:8px;vertical-align:middle;margin-right:8px">Narrative Radar</h1>
                    <p style="font-size:1.05rem;color:var(--text-secondary);margin-bottom:6px">Discover what's emerging on Solana before everyone else ‚Äî AI scans 600+ signals from GitHub, Twitter, DeFiLlama & on-chain data every 2 hours.</p>
                    <p style="font-size:0.85rem"><a href="https://github.com/0xksure/solana-narrative-radar#readme">How it works ‚Üí</a> ¬∑ <a href="#agents" style="color:var(--success);text-decoration:none">ü§ñ Agent API ‚Üí</a></p>
                    <div id="countdown-bar" style="margin-top:8px;font-size:0.8rem;color:var(--text-secondary);display:flex;align-items:center;gap:6px">
                        <span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--success);animation:pulse-dot 2s infinite"></span>
                        <span id="countdown-text">loading next update...</span>
                    </div>
                </div>
                <!-- Mobile sticky countdown -->
                <div id="mobile-countdown" style="display:none;position:sticky;top:0;z-index:100;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 16px;margin-bottom:16px;font-size:0.85rem;color:var(--text-secondary);align-items:center;gap:8px;backdrop-filter:blur(8px)">
                    <span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--success);animation:pulse-dot 2s infinite"></span>
                    <span id="mobile-countdown-text">loading...</span>
                </div>
                <div class="kpi-grid" id="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">Total Signals</div><div class="kpi-value" id="kpi-total"><span class="skeleton kpi-skeleton"></span></div><div class="kpi-change" id="kpi-total-change"></div></div>
                    <div class="kpi-card"><div class="kpi-label">GitHub</div><div class="kpi-value" id="kpi-github"><span class="skeleton kpi-skeleton"></span></div></div>
                    <div class="kpi-card"><div class="kpi-label">DeFi</div><div class="kpi-value" id="kpi-defi"><span class="skeleton kpi-skeleton"></span></div></div>
                    <div class="kpi-card"><div class="kpi-label">Social</div><div class="kpi-value" id="kpi-social"><span class="skeleton kpi-skeleton"></span></div></div>
                    <div class="kpi-card"><div class="kpi-label">On-chain</div><div class="kpi-value" id="kpi-onchain"><span class="skeleton kpi-skeleton"></span></div></div>
                    <div class="kpi-card"><div class="kpi-label">Narratives</div><div class="kpi-value accent" id="kpi-narratives"><span class="skeleton kpi-skeleton"></span></div></div>
                </div>
                <div class="overview-section-title">Detected Narratives</div>
                <div class="narrative-grid" id="narrative-grid">
                    <div class="skeleton-card"><div class="skeleton skeleton-line h24 w60"></div><div class="skeleton skeleton-line w80"></div><div class="skeleton skeleton-line w40"></div></div>
                    <div class="skeleton-card"><div class="skeleton skeleton-line h24 w60"></div><div class="skeleton skeleton-line w80"></div><div class="skeleton skeleton-line w40"></div></div>
                    <div class="skeleton-card"><div class="skeleton skeleton-line h24 w60"></div><div class="skeleton skeleton-line w80"></div><div class="skeleton skeleton-line w40"></div></div>
                </div>
                <footer class="main-footer">
                    <p>Autonomous AI Agent ¬∑ Monitors GitHub, DeFiLlama, Reddit & Twitter</p>
                    <div class="footer-links">
                        <a href="https://github.com/0xksure/solana-narrative-radar" target="_blank">GitHub</a>
                        <a href="https://github.com/0xksure/solana-narrative-radar#readme" target="_blank">Methodology</a>
                        <a href="https://defillama.com/" target="_blank">DeFiLlama</a>
                    </div>
                </footer>
            </div>
            <div class="detail-view" id="detail-view" style="display:none"></div>
            <div class="detail-view" id="agents-view" style="display:none">
                <h1 style="margin-bottom:8px">ü§ñ Agent API</h1>
                <p style="color:var(--text-secondary);margin-bottom:24px">Plug Solana Narrative Radar into your AI agent. Discover what to build on Solana programmatically.</p>

                <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;margin-bottom:16px">
                    <h3 style="margin-bottom:12px;color:var(--accent)">Quick Start</h3>
                    <code style="display:block;background:var(--bg-primary);padding:12px;border-radius:var(--radius-sm);font-size:13px;overflow-x:auto;white-space:pre">curl https://solana-narrative-radar-8vsib.ondigitalocean.app/api/agent/discover</code>
                </div>

                <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;margin-bottom:16px">
                    <h3 style="margin-bottom:12px">Endpoints</h3>
                    <div style="display:flex;flex-direction:column;gap:12px;font-size:13px">
                        <div>
                            <strong style="color:var(--success)">GET</strong> <code>/api/agent/ideas</code>
                            <div style="color:var(--text-secondary);margin-top:4px">All build ideas with full context. Filter: <code>?complexity=DAYS&amp;min_confidence=HIGH&amp;direction=ACCELERATING&amp;topic=defi</code></div>
                        </div>
                        <div>
                            <strong style="color:var(--success)">GET</strong> <code>/api/agent/ideas/{id}</code>
                            <div style="color:var(--text-secondary);margin-top:4px">Single idea with full detail + supporting signals</div>
                        </div>
                        <div>
                            <strong style="color:var(--success)">GET</strong> <code>/api/agent/narratives</code>
                            <div style="color:var(--text-secondary);margin-top:4px">All detected narratives with signal counts and ideas</div>
                        </div>
                        <div>
                            <strong style="color:var(--warning)">GET</strong> <code>/api/agent/discover</code>
                            <div style="color:var(--text-secondary);margin-top:4px">Best build idea right now ‚Äî includes <code>why_now</code> urgency field</div>
                        </div>
                    </div>
                </div>

                <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px;margin-bottom:16px">
                    <h3 style="margin-bottom:12px">OpenAPI &amp; Agent Discovery</h3>
                    <p style="font-size:13px;color:var(--text-secondary)">
                        <a href="/openapi.json" style="color:var(--accent)" target="_blank">OpenAPI Spec ‚Üí</a>&nbsp;&nbsp;
                        <a href="/.well-known/ai-plugin.json" style="color:var(--accent)" target="_blank">ai-plugin.json ‚Üí</a>
                    </p>
                </div>

                <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-md);padding:20px">
                    <h3 style="margin-bottom:12px">Example: Filter ideas</h3>
                    <code style="display:block;background:var(--bg-primary);padding:12px;border-radius:var(--radius-sm);font-size:13px;overflow-x:auto;white-space:pre"># Get only quick-build ideas from high-confidence narratives
curl "https://solana-narrative-radar-8vsib.ondigitalocean.app/api/agent/ideas?complexity=DAYS&amp;min_confidence=HIGH"

# Get all narratives
curl https://solana-narrative-radar-8vsib.ondigitalocean.app/api/agent/narratives</code>
                </div>
            </div>
        </main>
    </div>

    <div id="loading-overlay" style="display:none" class="loading-overlay">
        <div class="spinner"></div>
        <p>Generating narrative report‚Ä¶</p>
    </div>
    <div id="error-toast" style="display:none" class="error-toast"></div>

    <script>
        // Countdown timer
        (function initCountdown() {
            const el = document.getElementById('countdown-text');
            const mobileEl = document.getElementById('mobile-countdown-text');
            const dot = el?.previousElementSibling;
            const mobileDot = mobileEl?.previousElementSibling;
            function setText(text) { if (el) el.textContent = text; if (mobileEl) mobileEl.textContent = text; }
            function setDotColor(color) { if (dot) dot.style.background = color; if (mobileDot) mobileDot.style.background = color; }
            let nextRun = null;
            let wasRunning = false;
            async function fetchStatus() {
                try {
                    const r = await fetch('/api/pipeline-status');
                    const d = await r.json();
                    nextRun = d.next_run ? new Date(d.next_run) : null;
                    if (d.status === 'running') {
                        wasRunning = true;
                        setText('updating now...');
                        if (el) el.style.animation = 'pulse 1.5s infinite';
                        if (mobileEl) mobileEl.style.animation = 'pulse 1.5s infinite';
                        setDotColor('#f0b429');
                    } else if (wasRunning) {
                        wasRunning = false;
                        if (el) el.style.animation = '';
                        if (mobileEl) mobileEl.style.animation = '';
                        loadReport();
                    }
                } catch(e) {}
            }
            function tick() {
                if (!el || !nextRun) return;
                const diff = nextRun - Date.now();
                if (diff <= 0) {
                    setText('updating soon...');
                    setDotColor('#f0b429');
                    setTimeout(fetchStatus, 30000);
                    return;
                }
                setDotColor('var(--success)');
                const h = Math.floor(diff / 3600000);
                const m = Math.floor((diff % 3600000) / 60000);
                const s = Math.floor((diff % 60000) / 1000);
                const text = h > 0
                    ? `next update in ${h}h ${m}m`
                    : m > 0
                    ? `next update in ${m}m ${s}s`
                    : `next update in ${s}s`;
                setText(text);
            }
            fetchStatus();
            setInterval(tick, 1000);
            setInterval(fetchStatus, 120000);
        })();

        if (typeof Chart !== 'undefined') {
            Chart.defaults.color = '#5c5c74';
            Chart.defaults.borderColor = '#1e1e30';
            Chart.defaults.font.family = "'Inter', sans-serif";
        }

        let currentNarratives = [];
        let reportGeneratedAt = null;
        let chartInstances = {};
        let isGenerating = false;

        const SOURCE_ICONS = { github: 'üêô', twitter: 'üê¶', defi: 'üìä', 'on-chain': '‚õìÔ∏è', onchain: '‚õìÔ∏è', reddit: 'üí¨', defillama: 'üìä', jupiter: 'ü™ê' };
        const SOURCE_COLORS = { github: '#00d18c', twitter: '#1d9bf0', defillama: '#9945FF', defi: '#9945FF', reddit: '#ff4500', 'on-chain': '#14F195', onchain: '#14F195', jupiter: '#f5a623' };
        const KNOWN_KOLS = ['solana','aeyakovenko','rajgokal','0xmert_','jupiterexchange','driftprotocol','shaboronnikov','armaboronnikov','cburniske','lightcrypto'];
        const TREND_ARROWS = { accelerating: '‚Üó', emerging: '‚Üí', stabilizing: '‚Üò' };

        // === ROUTING ===
        function navigate(hash) {
            window.location.hash = hash;
        }

        function handleRoute() {
            const hash = window.location.hash.slice(1);
            if (hash === 'agents') { showAgentsView(); return; }
            const match = hash.match(/^narrative-(\d+)$/);
            if (match && currentNarratives.length > 0) {
                const idx = parseInt(match[1]);
                if (idx >= 0 && idx < currentNarratives.length) {
                    showDetail(idx);
                    return;
                }
            }
            showOverview();
        }

        window.addEventListener('hashchange', handleRoute);

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
            document.getElementById('sidebar-overlay').classList.toggle('visible');
        }
        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('sidebar-overlay').classList.remove('visible');
        }

        // === AGENTS VIEW ===
        function showAgentsView() {
            document.getElementById('overview-view').style.display = 'none';
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('agents-view').style.display = '';
            document.getElementById('main-content').scrollTop = 0;
            document.querySelectorAll('.sidebar-home').forEach(el => el.classList.remove('active'));
            document.getElementById('sidebar-agents').classList.add('active');
            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            closeSidebar();
        }

        // === OVERVIEW ===
        function showOverview() {
            document.getElementById('overview-view').style.display = '';
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('agents-view').style.display = 'none';
            document.getElementById('main-content').scrollTop = 0;
            updateSidebarActive(-1);
            closeSidebar();
        }

        // === DETAIL ===
        function showDetail(idx) {
            const n = currentNarratives[idx];
            if (!n) return;
            document.getElementById('overview-view').style.display = 'none';
            document.getElementById('agents-view').style.display = 'none';
            const dv = document.getElementById('detail-view');
            dv.style.display = '';
            document.getElementById('main-content').scrollTop = 0;
            updateSidebarActive(idx);
            closeSidebar();

            // Destroy old charts
            Object.keys(chartInstances).forEach(k => { chartInstances[k].destroy(); delete chartInstances[k]; });

            const conf = (n.confidence || 'low').toLowerCase();
            const dir = (n.direction || '').toLowerCase();
            const trend = ((n.velocity && n.velocity.trend) || dir || 'emerging').toLowerCase();
            const signals = n.supporting_signals || [];
            const hasDC = n.velocity && n.velocity.daily_counts && Object.keys(n.velocity.daily_counts).length > 0;
            const sourceCounts = getSourceCounts(signals);
            const hasSC = Object.keys(sourceCounts).length > 0;
            const prev = idx > 0 ? currentNarratives[idx - 1] : null;
            const next = idx < currentNarratives.length - 1 ? currentNarratives[idx + 1] : null;

            dv.innerHTML = `
                <div class="detail-back" onclick="navigate('')">‚Üê Back to Overview</div>
                <div class="detail-header">
                    <div class="detail-title">${esc(n.name)}</div>
                    <div class="detail-badges">
                        ${n.status ? `<span class="status-badge ${(n.status||'').toLowerCase()}">${n.status}</span>` : ''}
                        <span class="badge badge-${conf}">${n.confidence}</span>
                        <span class="badge badge-${dir}">${n.direction || ''}</span>
                        ${renderNarrativeTVLSummary(signals)}
                    </div>
                </div>
                ${renderVelocity(n)}
                ${n.detection_count ? `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;font-size:0.8rem;color:var(--text-muted)">
                    ${n.first_detected ? `<span>üìÖ First detected: ${freshness(n.first_detected)}</span>` : ''}
                    ${n.detection_count > 1 ? `<span>üîÅ Detected in <b>${n.detection_count}</b>${n.total_pipeline_runs ? '/' + n.total_pipeline_runs : ''} pipeline runs</span>` : ''}
                </div>` : ''}
                <p class="detail-explanation">${esc(n.explanation || '')}</p>
                ${n.trend_evidence ? `<div class="market-opportunity" style="border-left-color:var(--accent)"><div class="label">üìä Why ${n.direction || 'This Trend'}?</div><div class="content" style="white-space:pre-line">${esc(n.trend_evidence)}</div></div>` : ''}
                ${n.market_opportunity ? `<div class="why-build-section"><div class="label">üèóÔ∏è Why Build Here</div><div class="content">${esc(n.market_opportunity)}</div></div>` : ''}
                ${renderRiskIndicator(n)}
                ${renderKeyProjects(signals)}
                ${renderActionButtons(n)}
                ${renderDetailConfidenceChart(n)}
                ${hasDC || hasSC ? `<div class="charts-row">
                    <div class="trend-chart-wrap"${!hasDC ? ' style="display:none"' : ''}><canvas id="detail-trend"></canvas><div class="chart-label">Signal Trend (7d)</div></div>
                    <div class="donut-chart-wrap"${!hasSC ? ' style="display:none"' : ''}><canvas id="detail-donut" width="128" height="128"></canvas><div class="chart-label">Sources</div></div>
                </div>` : ''}
                ${renderNarrativeTrendCharts(n, signals)}
                ${renderSignalBreakdown(signals)}
                ${signals.length ? `<div class="detail-section">
                    <div class="detail-section-title">Supporting Signals (${signals.length})</div>
                    <div id="detail-signals">
                        ${signals.slice(0, 8).map((s, si) => renderSignal(s, si)).join('')}
                        ${signals.length > 8 ? `<div class="signals-hidden" style="display:none">${signals.slice(8, 15).map((s, si) => renderSignal(s, 8 + si)).join('')}</div>
                        <div class="show-all-toggle" onclick="toggleSignals(this)">Show ${Math.min(signals.length, 15) - 8} more signals ‚ñº</div>` : ''}
                    </div>
                </div>` : ''}
                ${n.ideas && n.ideas.length ? `<div class="ideas-section">
                    <div class="ideas-title">üí° Build Ideas</div>
                    <div class="ideas-subtitle">Product opportunities from AI analysis</div>
                    ${n.ideas.map(renderIdea).join('')}
                </div>` : ''}
                ${n.references && n.references.length ? `<div class="references">
                    <div class="label">References</div>
                    ${n.references.map(r => { const url = typeof r === 'string' ? r : r.url; const label = (typeof r === 'object' && r.title) ? r.title : shortUrl(url); return `<a href="${url}" target="_blank">${label}</a>`; }).join('')}
                </div>` : ''}
                <div class="detail-nav">
                    <button class="detail-nav-btn" ${!prev ? 'disabled' : `onclick="navigate('narrative-${idx-1}')"`}>
                        ‚Üê <span class="detail-nav-name">${prev ? esc(prev.name) : ''}</span>
                    </button>
                    <button class="detail-nav-btn" ${!next ? 'disabled' : `onclick="navigate('narrative-${idx+1}')"`}>
                        <span class="detail-nav-name">${next ? esc(next.name) : ''}</span> ‚Üí
                    </button>
                </div>
                <footer class="main-footer"><p>Autonomous AI Agent ¬∑ Monitors GitHub, DeFiLlama, Reddit & Twitter</p></footer>
            `;

            requestAnimationFrame(() => {
                if (hasDC) createTrendChart('detail-trend', n.velocity.daily_counts, trend);
                if (hasSC) createDonutChart('detail-donut', sourceCounts);
                createDetailConfidenceChart(n);
                createTVLMiniCharts();
                createNarrativeTrendCharts(signals);
            });
        }

        function updateSidebarActive(idx) {
            document.querySelectorAll('.sidebar-item').forEach((el, i) => el.classList.toggle('active', i === idx));
            document.getElementById('sidebar-home').classList.toggle('active', idx === -1);
        }

        // === SIDEBAR ===
        function renderSidebar(narratives) {
            document.getElementById('sidebar-count').textContent = narratives.length;
            const list = document.getElementById('sidebar-list');
            list.innerHTML = narratives.map((n, i) => {
                const conf = (n.confidence || 'low').toLowerCase();
                const trend = ((n.velocity && n.velocity.trend) || n.direction || 'emerging').toLowerCase();
                const status = (n.status || '').toLowerCase();
                const statusHtml = status ? `<span class="status-badge ${status}">${status}</span>` : '';
                const signals = n.supporting_signals || [];
                const sc = getSourceCounts(signals);
                const sourceCount = Object.keys(sc).length;
                const sourceIcons = Object.keys(sc).map(k => SOURCE_ICONS[k] || 'üìå').join('');
                const isFaded = (status === 'faded');
                return `<div class="sidebar-item" onclick="navigate('narrative-${i}')" ${isFaded ? 'style="opacity:0.5"' : ''}>
                    <div class="sidebar-item-info">
                        <div class="sidebar-item-name" title="${esc(n.name)}">${esc(n.name)}</div>
                        <div class="sidebar-item-meta">
                            ${statusHtml}
                            <span class="sidebar-badge ${conf}">${conf}</span>
                            <span class="sidebar-trend ${trend}">${TREND_ARROWS[trend] || '‚Üí'} ${trend}</span>
                        </div>
                        <div class="sidebar-sources">${sourceIcons} <span style="color:var(--text-muted);margin-left:2px">${sourceCount} sources ¬∑ ${signals.length} signals</span></div>
                        ${reportGeneratedAt ? `<div class="sidebar-freshness">Updated ${freshness(reportGeneratedAt)}</div>` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        // === GRID CARDS ===
        function renderOverviewGrid(narratives) {
            const grid = document.getElementById('narrative-grid');
            if (!narratives.length) {
                grid.innerHTML = '<div style="text-align:center;padding:48px;color:var(--text-muted)"><p>No narratives detected yet.</p><br><button class="btn" onclick="generateReport()">Generate Report</button></div>';
                return;
            }
            const active = [], faded = [];
            narratives.forEach((n, i) => {
                const isFaded = (n.status || '').toUpperCase() === 'FADED';
                (isFaded ? faded : active).push({ n, i });
            });

            function renderCard({ n, i }) {
                const conf = (n.confidence || 'low').toLowerCase();
                const isFaded = (n.status || '').toUpperCase() === 'FADED';
                const signals = n.supporting_signals || [];
                const sc = getSourceCounts(signals);
                const trend = ((n.velocity && n.velocity.trend) || n.direction || 'emerging').toLowerCase();
                const fadedTime = isFaded && (n.faded_at || n.last_detected) ? `<span style="font-size:0.7rem;color:var(--text-muted)">Faded ${freshness(n.faded_at || n.last_detected)}</span>` : '';
                return `<div class="narrative-grid-card confidence-${conf}${isFaded ? ' faded-card' : ''}" onclick="navigate('narrative-${i}')">
                    <div class="grid-card-header">
                        <div class="grid-card-name">${esc(n.name)}</div>
                        <div class="grid-card-badges">
                            ${isFaded ? '<span class="faded-badge">FADED</span>' : (n.status ? `<span class="status-badge ${(n.status||'').toLowerCase()}">${n.status}</span>` : '')}
                            <span class="badge badge-${conf}" style="font-size:0.65rem;padding:2px 8px">${n.confidence}</span>
                        </div>
                    </div>
                    <div class="grid-card-desc">${esc(n.explanation || '')}</div>
                    <div class="grid-card-footer">
                        <span class="sidebar-trend ${trend}" style="font-size:0.75rem">${TREND_ARROWS[trend] || '‚Üí'} ${trend}</span>
                        <span>¬∑</span>
                        <span>${signals.length} signals</span>
                        ${n.detection_count > 1 ? `<span>¬∑ <b>${n.detection_count}√ó</b> detected</span>` : ''}
                        ${fadedTime}
                        <div class="grid-card-signals">${Object.keys(sc).map(k => `<span title="${k}">${SOURCE_ICONS[k] || 'üìå'}</span>`).join('')}</div>
                    </div>
                    ${renderCardSparkline(n, i)}
                </div>`;
            }

            let html = active.map(renderCard).join('');
            if (faded.length) {
                html += `<div class="faded-section-title" style="grid-column:1/-1">üëª Recently Faded (${faded.length})</div>`;
                html += faded.map(renderCard).join('');
            }
            grid.innerHTML = html;
        }

        // === KPIs ===
        function animateKPI(el, value) {
            el.classList.add('animated');
            const target = parseInt(value) || 0;
            if (target === 0) { el.textContent = '0'; return; }
            const duration = 600, steps = 30, inc = target / steps;
            let current = 0, step = 0;
            const timer = setInterval(() => {
                step++;
                current = step >= steps ? target : Math.round(inc * step);
                el.textContent = current.toLocaleString();
                if (step >= steps) clearInterval(timer);
            }, duration / steps);
        }
        function dismissLoadingOverlay() {
            const ol = document.getElementById('loading-overlay-init');
            if (ol) { ol.classList.add('fade-out'); setTimeout(() => ol.remove(), 500); }
        }
        function renderKPIs(data, skipAnimation) {
            const s = data.signal_summary || {};
            reportGeneratedAt = data.generated_at;
            const vals = {
                'kpi-total': s.total_collected || 0,
                'kpi-github': s.github_signals || 0,
                'kpi-defi': s.defi_signals || 0,
                'kpi-social': s.social_signals || 0,
                'kpi-onchain': s.onchain_signals || 0,
                'kpi-narratives': (data.narratives || []).length || 0,
            };
            Object.entries(vals).forEach(([id, val]) => {
                const el = document.getElementById(id);
                if (skipAnimation) { el.textContent = val.toLocaleString(); }
                else { animateKPI(el, val); }
            });
            dismissLoadingOverlay();
            // Trend
            const narratives = data.narratives || [];
            let todayTotal = 0, yesterdayTotal = 0;
            narratives.forEach(n => {
                const dc = n.velocity && n.velocity.daily_counts;
                if (!dc) return;
                const dates = Object.keys(dc).sort();
                if (dates.length >= 1) todayTotal += dc[dates[dates.length - 1]] || 0;
                if (dates.length >= 2) yesterdayTotal += dc[dates[dates.length - 2]] || 0;
            });
            const changeEl = document.getElementById('kpi-total-change');
            if (yesterdayTotal > 0 && todayTotal > 0) {
                const pct = Math.round(((todayTotal - yesterdayTotal) / yesterdayTotal) * 100);
                changeEl.className = `kpi-change ${pct >= 0 ? 'up' : 'down'}`;
                changeEl.textContent = `${pct >= 0 ? '+' : ''}${pct}% vs yesterday`;
            }
        }

        // === HELPERS ===
        function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
        function freshness(iso) {
            try {
                const dt = new Date(iso);
                const ms = Date.now() - dt.getTime();
                const mins = Math.floor(ms / 60000);
                if (mins < 60) return mins + 'm ago';
                const hrs = Math.floor(mins / 60);
                if (hrs < 24) return hrs + 'h ago';
                const days = Math.floor(hrs / 24);
                return days + 'd ago';
            } catch(e) { return 'unknown'; }
        }

        function getSourceCounts(signals) {
            const c = {};
            (signals || []).forEach(s => { if (typeof s === 'object' && s.source) c[s.source.toLowerCase()] = (c[s.source.toLowerCase()] || 0) + 1; });
            return c;
        }

        function formatTVL(val) {
            if (val >= 1e9) return '$' + (val / 1e9).toFixed(1) + 'B';
            if (val >= 1e6) return '$' + (val / 1e6).toFixed(1) + 'M';
            if (val >= 1e3) return '$' + (val / 1e3).toFixed(1) + 'K';
            return '$' + val.toFixed(0);
        }

        function shortUrl(url) {
            try { const u = new URL(url); return u.hostname.replace('www.', '') + (u.pathname.length > 25 ? u.pathname.slice(0, 25) + '‚Ä¶' : u.pathname); }
            catch(e) { return url; }
        }

        function linkify(text) {
            return text.replace(/(https?:\/\/[^\s<]+)/g, url => {
                let label = url;
                try { const u = new URL(url); label = u.hostname.replace('www.', '') + (u.pathname.length > 20 ? u.pathname.slice(0, 20) + '‚Ä¶' : u.pathname); } catch(e) {}
                return `<a href="${url}" target="_blank">${label}</a>`;
            });
        }

        function renderNarrativeTVLSummary(signals) {
            const tvlSignals = (signals || []).filter(s => typeof s === 'object' && s.tvl_history && s.tvl_history.length >= 2);
            if (!tvlSignals.length) return '';
            let totalFirst = 0, totalLast = 0;
            tvlSignals.forEach(s => { totalFirst += s.tvl_history[0].tvl || 0; totalLast += s.tvl_history[s.tvl_history.length - 1].tvl || 0; });
            if (!totalFirst && !totalLast) return '';
            const pct = totalFirst > 0 ? ((totalLast - totalFirst) / totalFirst * 100).toFixed(0) : 0;
            const dir = totalLast >= totalFirst ? 'up' : 'down';
            return `<span class="narrative-tvl-summary ${dir}">üìä ${formatTVL(totalLast)} (${pct >= 0 ? '+' : ''}${pct}% 30d)</span>`;
        }

        function renderVelocity(n) {
            const v = n.velocity; if (!v) return '';
            const trend = (v.trend || n.direction || 'emerging').toLowerCase();
            return `<div class="velocity-section">
                <span class="velocity-number ${trend}">${v.velocity != null ? v.velocity : ''}</span>
                <span class="velocity-trend">${TREND_ARROWS[trend] || '‚Üí'} ${trend}</span>
                ${renderSparkline(v)}
            </div>`;
        }

        function renderSparkline(v) {
            if (!v || !v.daily_counts) return '';
            const dates = Object.keys(v.daily_counts).sort().slice(-7);
            if (!dates.length) return '';
            const vals = dates.map(d => v.daily_counts[d]);
            const max = Math.max(...vals, 1);
            const trend = (v.trend || 'emerging').toLowerCase();
            return `<div class="sparkline-container">${vals.map(val => `<div class="sparkline-bar ${trend}" style="height:${Math.max(2, (val / max) * 22)}px"></div>`).join('')}</div>`;
        }

        function renderSignalBreakdown(signals) {
            if (!signals || !signals.length) return '';
            const counts = {};
            signals.forEach(s => { if (typeof s === 'object' && s.source) counts[s.source.toLowerCase()] = (counts[s.source.toLowerCase()] || 0) + 1; });
            const parts = Object.entries(counts).map(([k, v]) => `${SOURCE_ICONS[k] || 'üìå'} ${v} ${k}`);
            if (!parts.length) return '';
            return `<div class="signal-breakdown">${signals.length} signals: ${parts.join(' ¬∑ ')}</div>`;
        }

        let tvlIdx = 0;
        function renderSignal(s, si) {
            if (typeof s === 'string') return `<div class="signal-item"><div class="signal-main">${linkify(s)}</div></div>`;
            const badge = s.source ? `<span class="source-badge">${SOURCE_ICONS[s.source.toLowerCase()] || 'üìå'}</span>` : '';
            const text = s.url ? `<a href="${s.url}" target="_blank">${s.text || shortUrl(s.url)}</a>` : (s.text || '');
            const comment = s.comment ? `<div class="signal-comment">${s.comment}</div>` : '';
            let tvlChart = '';
            if (s.tvl_history && s.tvl_history.length >= 2) {
                const cid = `tvl-mini-${tvlIdx++}`;
                tvlChart = `<div class="tvl-mini-chart-wrap"><canvas id="${cid}" width="120" height="60" data-tvl='${JSON.stringify(s.tvl_history)}'></canvas></div>`;
            }
            const meta = renderSignalMeta(s);
            return `<div class="signal-item"><div class="signal-main">${badge}${text}${tvlChart}</div>${comment}${meta}</div>`;
        }

        function renderSignalMeta(s) {
            const parts = [];
            if (s.stars != null || s.forks != null) {
                let gh = [];
                if (s.stars != null) gh.push(`‚≠ê ${s.stars}`);
                if (s.forks != null) gh.push(`üç¥ ${s.forks}`);
                parts.push(gh.join(' ¬∑ '));
                if (s.pushed_at && (Date.now() - new Date(s.pushed_at).getTime()) < 7 * 86400000)
                    parts.push('<span class="meta-badge active">üü¢ Active</span>');
            }
            if (s.likes != null || s.retweets != null) {
                let tw = [];
                if (s.likes != null) tw.push(`‚ù§Ô∏è ${s.likes}`);
                if (s.retweets != null) tw.push(`üîÑ ${s.retweets}`);
                parts.push(tw.join(' ¬∑ '));
                if (s.author && KNOWN_KOLS.some(k => s.author.toLowerCase().includes(k)))
                    parts.push('<span class="meta-badge kol">üî∑ KOL</span>');
                // Engagement tier
                const eng = (s.likes || 0) + (s.retweets || 0);
                if (eng >= 500) parts.push('<span class="meta-badge" style="border-color:#f59e0b;color:#f59e0b">üî• Viral</span>');
                else if (eng >= 100) parts.push('<span class="meta-badge active">üìà High Engagement</span>');
            }
            if (s.tvl_history && s.tvl_history.length >= 2) {
                const first = s.tvl_history[0].tvl, last = s.tvl_history[s.tvl_history.length - 1].tvl;
                const pct = first > 0 ? ((last - first) / first * 100).toFixed(1) : 0;
                const dir = last >= first ? 'up' : 'down';
                parts.push(`<span class="tvl-summary ${dir}">TVL: ${formatTVL(first)} ‚Üí ${formatTVL(last)} (${pct >= 0 ? '+' : ''}${pct}%)</span>`);
            }
            if (!parts.length) return '';
            return `<div class="signal-meta-row">${parts.join(' ')}</div>`;
        }

        function renderIdea(idea) {
            return `<div class="idea-card">
                <div class="idea-name">${esc(idea.name)}</div>
                <div class="idea-desc">${esc(idea.description)}</div>
                ${renderKeyMetrics(idea.key_metrics)}
                ${idea.market_analysis ? `<div class="idea-market-analysis">üìä ${esc(idea.market_analysis)}</div>` : ''}
                ${idea.revenue_model ? `<div class="idea-revenue">üí∞ ${esc(idea.revenue_model)}</div>` : ''}
                <div class="idea-meta">${idea.complexity ? `‚è±Ô∏è ${idea.complexity}` : ''}${idea.target_user ? ` ¬∑ üë§ ${idea.target_user}` : ''}${idea.solana_integrations ? ` ¬∑ üîó ${idea.solana_integrations.join(', ')}` : ''}</div>
                ${idea.why_it_wins ? `<div class="idea-why-now"><span class="prefix">üìà Why now:</span> ${esc(idea.why_it_wins)}</div>` : ''}
                ${idea.reference_links && idea.reference_links.length ? `<div class="idea-refs">Similar: ${idea.reference_links.map(l => `<a href="${l}" target="_blank">${shortUrl(l)}</a>`).join(', ')}</div>` : ''}
            </div>`;
        }

        function renderKeyMetrics(metrics) {
            if (!metrics || !metrics.length) return '';
            return `<div class="key-metrics-row">${metrics.map(m => `
                <div class="key-metric-card">
                    <div class="key-metric-label">${m.label || ''}</div>
                    <div class="key-metric-value">${m.value || ''}</div>
                    ${m.context ? `<div class="key-metric-context">${m.context}</div>` : ''}
                </div>`).join('')}</div>`;
        }

        // === SPARKLINES ===
        function getSparklineColor(n) {
            const dir = (n.direction || '').toLowerCase();
            if (dir === 'accelerating') return '#00d18c';
            if (dir === 'stabilizing' || dir === 'stable') return '#f5a623';
            if (dir === 'declining' || dir === 'fading') return '#f87171';
            return '#f5a623'; // EMERGING default
        }

        function renderCardSparkline(n, idx) {
            const hist = n.confidence_history || [];
            if (hist.length < 2) return '';
            return `<canvas id="sparkline-${idx}" width="120" height="40" style="margin-top:8px;width:100%;height:40px"></canvas>`;
        }

        function createCardSparklines() {
            if (typeof Chart === 'undefined') return;
            currentNarratives.forEach((n, i) => {
                const canvas = document.getElementById(`sparkline-${i}`);
                if (!canvas) return;
                const hist = n.confidence_history || [];
                if (hist.length < 2) return;
                const confMap = { HIGH: 3, MEDIUM: 2, LOW: 1 };
                const vals = hist.map(h => confMap[h.confidence] || 1);
                const color = getSparklineColor(n);
                const ctx = canvas.getContext('2d');
                const grad = ctx.createLinearGradient(0, 0, 0, 40);
                grad.addColorStop(0, color + '33');
                grad.addColorStop(1, 'rgba(0,0,0,0)');
                new Chart(ctx, {
                    type: 'line',
                    data: { labels: vals.map(() => ''), datasets: [{ data: vals, borderColor: color, backgroundColor: grad, fill: true, tension: 0.4, pointRadius: 0, borderWidth: 1.5 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } }, scales: { x: { display: false }, y: { display: false, min: 0, max: 4 } }, animation: { duration: 600 } }
                });
            });
        }

        function renderDetailConfidenceChart(n) {
            const hist = n.confidence_history || [];
            if (hist.length < 2) return '';
            return `<div class="trend-chart-wrap" style="margin-bottom:20px"><canvas id="detail-confidence-trend"></canvas><div class="chart-label">Confidence & Detection Over Pipeline Runs</div></div>`;
        }

        function createDetailConfidenceChart(n) {
            if (typeof Chart === 'undefined') return;
            const canvas = document.getElementById('detail-confidence-trend');
            if (!canvas) return;
            const hist = n.confidence_history || [];
            if (hist.length < 2) return;
            const confMap = { HIGH: 3, MEDIUM: 2, LOW: 1 };
            const labels = hist.map((h, i) => {
                try { const d = new Date(h.time); return (d.getMonth()+1) + '/' + d.getDate() + ' ' + d.getHours() + ':00'; }
                catch(e) { return '#' + (i+1); }
            });
            const confVals = hist.map(h => confMap[h.confidence] || 1);
            const color = getSparklineColor(n);
            const ctx = canvas.getContext('2d');
            const grad = ctx.createLinearGradient(0, 0, 0, 200);
            grad.addColorStop(0, color + '22'); grad.addColorStop(1, 'rgba(0,0,0,0)');
            if (chartInstances['detail-confidence-trend']) chartInstances['detail-confidence-trend'].destroy();
            chartInstances['detail-confidence-trend'] = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{
                    label: 'Confidence',
                    data: confVals, borderColor: color, backgroundColor: grad, fill: true,
                    tension: 0.35, pointRadius: 3, pointBackgroundColor: color, borderWidth: 2
                }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => ['', 'LOW', 'MEDIUM', 'HIGH'][c.parsed.y] || '' } } },
                    scales: { x: { grid: { color: '#1e1e30' }, ticks: { color: '#5c5c74', font: { size: 9 }, maxTicksLimit: 8 } }, y: { grid: { color: '#1e1e30' }, min: 0, max: 4, ticks: { color: '#5c5c74', font: { size: 10 }, stepSize: 1, callback: v => ['', 'LOW', 'MED', 'HIGH', ''][v] || '' } } } }
            });
        }

        // === INVESTMENT SIGNALS ===
        function renderRiskIndicator(n) {
            const conf = CONFIDENCE_ORDER[n.confidence] || 1;
            const dir = DIRECTION_ORDER[n.direction] || 1;
            const score = conf + dir;
            let riskClass, riskText;
            if (score >= 5) { riskClass = 'risk-low'; riskText = 'üü¢ Lower Risk ‚Äî Strong signals, established trend'; }
            else if (score >= 3) { riskClass = 'risk-medium'; riskText = 'üü° Medium Risk ‚Äî Growing signals, monitor closely'; }
            else { riskClass = 'risk-high'; riskText = 'üî¥ Higher Risk ‚Äî Early signals, high upside potential'; }
            return `<div style="margin-bottom:16px"><span class="risk-indicator ${riskClass}">${riskText}</span></div>`;
        }
        const CONFIDENCE_ORDER = { HIGH: 3, MEDIUM: 2, LOW: 1 };
        const DIRECTION_ORDER = { ACCELERATING: 3, EMERGING: 2, STABILIZING: 1 };

        const KNOWN_PROTOCOLS = {
            'jupiter': 'https://jup.ag', 'jup': 'https://jup.ag',
            'raydium': 'https://raydium.io', 'orca': 'https://orca.so',
            'marinade': 'https://marinade.finance', 'jito': 'https://jito.network',
            'drift': 'https://drift.trade', 'phoenix': 'https://phoenix.trade',
            'tensor': 'https://tensor.trade', 'phantom': 'https://phantom.app',
            'backpack': 'https://backpack.exchange', 'pump.fun': 'https://pump.fun',
            'helium': 'https://helium.com', 'render': 'https://render.com',
            'pyth': 'https://pyth.network', 'wormhole': 'https://wormhole.com',
            'marginfi': 'https://marginfi.com', 'kamino': 'https://kamino.finance',
            'solend': 'https://solend.fi', 'bonk': 'https://bonkcoin.com',
            'metaplex': 'https://metaplex.com', 'squads': 'https://squads.so',
            'sanctum': 'https://sanctum.so', 'parcl': 'https://parcl.co',
        };

        function renderKeyProjects(signals) {
            const found = new Map();
            const allText = signals.map(s => typeof s === 'string' ? s : (s.text || s.name || s.content || '')).join(' ').toLowerCase();
            for (const [name, url] of Object.entries(KNOWN_PROTOCOLS)) {
                if (allText.includes(name)) found.set(name.charAt(0).toUpperCase() + name.slice(1), url);
            }
            if (!found.size) return '';
            let html = '<div class="detail-section"><div class="detail-section-title">üîë Key Projects Mentioned</div><div class="key-projects">';
            for (const [name, url] of found) {
                html += `<a href="${url}" target="_blank" class="key-project-tag">${name} ‚Üó</a>`;
            }
            html += '</div></div>';
            return html;
        }

        function renderActionButtons(n) {
            const name = encodeURIComponent(n.name || '');
            const topics = (n.topics || []).join(',');
            // Map narrative to DeFiLlama category
            const defiLlamaMap = { 'defi': 'Lending', 'trading': 'Dexes', 'staking': 'Liquid+Staking', 'nft': 'NFT+Marketplace', 'gaming': 'Gaming', 'ai_agents': 'AI' };
            let llamaCategory = 'Solana';
            for (const [topic, cat] of Object.entries(defiLlamaMap)) {
                if (topics.includes(topic)) { llamaCategory = cat; break; }
            }
            return `<div class="action-buttons">
                <a href="https://solana.com/ecosystem" target="_blank" class="action-btn">üîç Explore Ecosystem</a>
                <a href="https://defillama.com/chain/Solana" target="_blank" class="action-btn">üìä Track on DeFiLlama</a>
                <a href="https://solana.com/developers" target="_blank" class="action-btn">üìö Solana Docs</a>
                <a href="https://github.com/search?q=solana+${name}&type=repositories" target="_blank" class="action-btn">üêô GitHub Repos</a>
            </div>`;
        }

        function toggleSignals(el) {
            const hidden = el.previousElementSibling;
            if (!hidden) return;
            const showing = hidden.style.display !== 'none';
            hidden.style.display = showing ? 'none' : 'block';
            el.textContent = showing ? `Show all ‚ñº` : 'Show less ‚ñ≤';
        }

        // === CHARTS ===
        function getTrendColor(trend) {
            if (trend === 'accelerating') return { line: '#00d18c', bg: 'rgba(0,209,140,0.12)' };
            if (trend === 'emerging') return { line: '#f5a623', bg: 'rgba(245,166,35,0.12)' };
            return { line: '#8888a0', bg: 'rgba(136,136,160,0.08)' };
        }

        function createTrendChart(canvasId, dailyCounts, trend) {
            if (typeof Chart === 'undefined') return;
            const canvas = document.getElementById(canvasId);
            if (!canvas || !dailyCounts) return;
            const dates = Object.keys(dailyCounts).sort();
            if (!dates.length) return;
            const values = dates.map(d => dailyCounts[d]);
            const colors = getTrendColor(trend);
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, colors.bg); gradient.addColorStop(1, 'rgba(0,0,0,0)');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels: dates.map(d => d.slice(5)), datasets: [{ data: values, borderColor: colors.line, backgroundColor: gradient, fill: true, tension: 0.35, pointRadius: 3, pointBackgroundColor: colors.line, borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } }, scales: { x: { grid: { color: '#1e1e30' }, ticks: { color: '#5c5c74', font: { size: 10 } } }, y: { grid: { color: '#1e1e30' }, ticks: { color: '#5c5c74', font: { size: 10 } }, beginAtZero: true } } }
            });
        }

        function createDonutChart(canvasId, sourceCounts) {
            if (typeof Chart === 'undefined') return;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const entries = Object.entries(sourceCounts);
            if (!entries.length) return;
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            chartInstances[canvasId] = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: { labels: entries.map(([k]) => k), datasets: [{ data: entries.map(([,v]) => v), backgroundColor: entries.map(([k]) => SOURCE_COLORS[k] || '#5c5c74'), borderWidth: 0 }] },
                options: { responsive: false, plugins: { legend: { display: false }, tooltip: { enabled: true } }, cutout: '65%' }
            });
        }

        function createTVLMiniCharts() {
            if (typeof Chart === 'undefined') return;
            document.querySelectorAll('canvas[id^="tvl-mini-"]').forEach(canvas => {
                if (canvas.dataset.rendered) return;
                let hist;
                try { hist = JSON.parse(canvas.dataset.tvl); } catch(e) { return; }
                if (!hist || hist.length < 2) return;
                const ctx = canvas.getContext('2d');
                const vals = hist.map(h => h.tvl);
                const labels = hist.map(h => h.date ? h.date.slice(5) : '');
                const up = vals[vals.length - 1] >= vals[0];
                const lineColor = up ? '#00d18c' : '#f87171';
                const grad = ctx.createLinearGradient(0, 0, 0, 60);
                grad.addColorStop(0, up ? 'rgba(0,209,140,0.3)' : 'rgba(248,113,113,0.3)');
                grad.addColorStop(1, 'rgba(0,0,0,0)');
                canvas.dataset.rendered = '1';
                new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ data: vals, borderColor: lineColor, backgroundColor: grad, fill: true, tension: 0.3, pointRadius: 0, borderWidth: 1.5 }] },
                    options: { responsive: false, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, callbacks: { label: c => formatTVL(c.parsed.y) } } }, scales: { x: { display: false }, y: { display: false } } }
                });
            });
        }

        // === NARRATIVE TREND CHARTS ===
        function renderNarrativeTrendCharts(n, signals) {
            const hasTVL = signals.some(s => s.tvl_history && s.tvl_history.length >= 2);
            const hasSocial = signals.some(s => (s.source === 'twitter' || s.source === 'reddit') && (s.likes || s.retweets));
            if (!hasTVL && !hasSocial) return '';
            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:20px">';
            if (hasTVL) html += '<div class="trend-chart-wrap"><canvas id="narrative-tvl-trend"></canvas><div class="chart-label">TVL Trend (30d)</div></div>';
            if (hasSocial) html += '<div class="trend-chart-wrap"><canvas id="narrative-social-trend"></canvas><div class="chart-label">Social Engagement</div></div>';
            html += '</div>';
            return html;
        }

        function createNarrativeTrendCharts(signals) {
            if (typeof Chart === 'undefined') return;
            // TVL trend: aggregate tvl_history from all defillama signals
            const tvlCanvas = document.getElementById('narrative-tvl-trend');
            if (tvlCanvas) {
                const tvlSignals = signals.filter(s => s.tvl_history && s.tvl_history.length >= 2);
                if (tvlSignals.length) {
                    const dateMap = {};
                    tvlSignals.forEach(s => {
                        s.tvl_history.forEach(h => {
                            const d = (h.date || '').slice(0, 10);
                            if (d) dateMap[d] = (dateMap[d] || 0) + (h.tvl || 0);
                        });
                    });
                    const dates = Object.keys(dateMap).sort();
                    const vals = dates.map(d => dateMap[d]);
                    const up = vals.length >= 2 && vals[vals.length-1] >= vals[0];
                    const lineColor = up ? '#00d18c' : '#f87171';
                    const ctx = tvlCanvas.getContext('2d');
                    const grad = ctx.createLinearGradient(0, 0, 0, 200);
                    grad.addColorStop(0, up ? 'rgba(0,209,140,0.15)' : 'rgba(248,113,113,0.15)');
                    grad.addColorStop(1, 'rgba(0,0,0,0)');
                    chartInstances['narrative-tvl-trend'] = new Chart(ctx, {
                        type: 'line',
                        data: { labels: dates.map(d => d.slice(5)), datasets: [{ data: vals, borderColor: lineColor, backgroundColor: grad, fill: true, tension: 0.35, pointRadius: 2, borderWidth: 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { callbacks: { label: c => formatTVL(c.parsed.y) } } }, scales: { x: { grid: { color: '#1e1e30' }, ticks: { color: '#5c5c74', font: { size: 10 }, maxTicksLimit: 8 } }, y: { grid: { color: '#1e1e30' }, ticks: { color: '#5c5c74', font: { size: 10 }, callback: v => formatTVL(v) } } } }
                    });
                }
            }
            // Social engagement chart
            const socialCanvas = document.getElementById('narrative-social-trend');
            if (socialCanvas) {
                const socialSignals = signals.filter(s => (s.source === 'twitter' || s.source === 'reddit') && (s.likes || s.retweets));
                if (socialSignals.length) {
                    const labels = socialSignals.slice(0, 15).map((s, i) => (s.author || `#${i+1}`).slice(0, 12));
                    const likes = socialSignals.slice(0, 15).map(s => s.likes || 0);
                    const rts = socialSignals.slice(0, 15).map(s => s.retweets || 0);
                    const ctx = socialCanvas.getContext('2d');
                    chartInstances['narrative-social-trend'] = new Chart(ctx, {
                        type: 'bar',
                        data: { labels, datasets: [
                            { label: 'Likes', data: likes, backgroundColor: 'rgba(29,155,240,0.6)', borderRadius: 3 },
                            { label: 'Retweets', data: rts, backgroundColor: 'rgba(0,209,140,0.6)', borderRadius: 3 }
                        ] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#8888a0', font: { size: 10 } } } }, scales: { x: { grid: { display: false }, ticks: { color: '#5c5c74', font: { size: 9 }, maxRotation: 45 } }, y: { grid: { color: '#1e1e30' }, ticks: { color: '#5c5c74', font: { size: 10 } }, beginAtZero: true } } }
                    });
                }
            }
        }

        // === ERRORS ===
        function showError(msg) {
            const toast = document.getElementById('error-toast');
            toast.innerHTML = `‚ö†Ô∏è ${msg} <button onclick="hideError(); generateReport()">Retry</button>`;
            toast.style.display = 'flex'; setTimeout(hideError, 8000);
        }
        function hideError() { document.getElementById('error-toast').style.display = 'none'; }

        // === API ===
        async function loadReport() {
            // Show cached data instantly if available
            try {
                const cached = localStorage.getItem('nr_cached_report');
                if (cached) {
                    const cData = JSON.parse(cached);
                    if (cData.narratives && cData.narratives.length > 0) {
                        currentNarratives = cData.narratives;
                        renderKPIs(cData, true);
                        renderSidebar(cData.narratives);
                        renderOverviewGrid(cData.narratives);
                        handleRoute();
                    }
                }
            } catch(e) { /* ignore cache errors */ }
            try {
                const resp = await fetch('/api/narratives');
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();
                try { localStorage.setItem('nr_cached_report', JSON.stringify(data)); } catch(e) {}
                if (data.narratives && data.narratives.length > 0) {
                    currentNarratives = data.narratives;
                    renderKPIs(data);
                    renderSidebar(data.narratives);
                    renderOverviewGrid(data.narratives);
                    requestAnimationFrame(createCardSparklines);
                    handleRoute();
                    autoSelectFirst();
                } else {
                    document.getElementById('narrative-grid').innerHTML = '<div style="text-align:center;padding:48px;color:var(--text-muted)"><p>No narratives detected yet.</p><br><button class="btn" onclick="generateReport()">Generate Report</button></div>';
                    dismissLoadingOverlay();
                }
            } catch(e) {
                if (typeof Sentry !== 'undefined') Sentry.captureException(e);
                document.getElementById('narrative-grid').innerHTML = '<div style="text-align:center;padding:48px;color:var(--text-muted)"><p>Could not load data.</p><br><button class="btn" onclick="generateReport()">Generate Report</button></div>';
                dismissLoadingOverlay();
            }
        }

        async function generateReport() {
            if (isGenerating) return;
            isGenerating = true;
            document.getElementById('loading-overlay').style.display = 'flex';
            try {
                const resp = await fetch('/api/generate', { method: 'POST' });
                if (!resp.ok) throw new Error(`Server error (${resp.status})`);
                const data = await resp.json();
                currentNarratives = data.narratives || [];
                renderKPIs(data);
                renderSidebar(currentNarratives);
                renderOverviewGrid(currentNarratives);
                requestAnimationFrame(createCardSparklines);
                handleRoute();
            } catch(e) {
                if (typeof Sentry !== 'undefined') Sentry.captureException(e);
                showError(`Failed to generate: ${e.message}`);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
                isGenerating = false;
            }
        }

        // Keyboard nav
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            const hash = window.location.hash.slice(1);
            const match = hash.match(/^narrative-(\d+)$/);
            if (!match) return;
            const idx = parseInt(match[1]);
            if (e.key === 'ArrowLeft' || e.key === 'k') { if (idx > 0) navigate('narrative-' + (idx - 1)); e.preventDefault(); }
            if (e.key === 'ArrowRight' || e.key === 'j') { if (idx < currentNarratives.length - 1) navigate('narrative-' + (idx + 1)); e.preventDefault(); }
            if (e.key === 'Escape') { navigate(''); e.preventDefault(); }
        });

        // Analytics
        function trackEvent(event, props = {}) {
            fetch('/api/analytics', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({event, properties: {...props, url: location.href}}) }).catch(() => {});
        }
        trackEvent('page_view', { screen_width: screen.width });

        loadReport();
        // Auto-navigate to first narrative if no hash set
        function autoSelectFirst() {
            if (!window.location.hash && currentNarratives.length > 0) {
                navigate('narrative-0');
            }
        }
    </script>
</body>
</html>
